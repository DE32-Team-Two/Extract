import requests
import os
import pandas as pd


def get_url_params(url_params={}):
    return url_params


def ice_breaking():
    return """
        ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,...........................................................
        ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,...,.....................................................
        ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.,.,....................................................
        ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,..,..................................................
        --,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.,.,..............................................,
        ----,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.,....................................,,,.,,,,
        -----,,-,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.,,,.,,,....,.,.,,,.,.,,....,..,..,,,,,,,,,,,
        -----------,-,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
        -------------,--,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
        -------------------,-,-,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
        -------------------,,-------,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
        ----------------------------------------,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,-
        -~-----------------------------,----------,------,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,---------~-
        ,-~---------------------------------------------,-----,,,,------------------~~:;!*******!!**!*******
        ,-~~~~~~~~~--------------------------------~::;!*****!!!!!!!!!*****=======**=****!***************$**
        ,,-~~:~~~~~~::;;!!!*!!!!!!!!!!!!**========**=********=***********!!!!!!!!!!***!*****!!!**********=*!
        ,,--=#$$$====================*!!;!!******************=**!**!!!!!!!!!!!!!!!!*!!!!!***************!!*!
        ,,,-=$========****************!!!!!!*!***************=*******!!!!!!;;;;;;!!*!!!!!!!!*!!!!!*!!!!!!**!
        ,,,-=$*==***=**************!!*;;;;!!!*****************!!!!!!!!!!!!;;:~~::;!;*!!!!!!!!!!!!!!!!!!!!!*!
        ,,,-=$**===*=*************!!;!:--~:;!!!**!!***!***!!!!!!!!!!!!!!!;;:,..-:;!;=!!!!!!!!!!!!!!;;!!!!!*;
        ,,,-=$***=********!!******!!;;-. ,~;!!!!!!!**!!*!!!!!!:;!!!!!!!;;;:-   .~:;;*!!!!!!!!!!!;;-  :;;;;=;
        ,,,~==****=*****!;::~!==*!!!;~.   -:;!!!!!!!!!!!!!!;:: -:;;;;;;;::~-   ,~:;;!!;;;;;;;;;;;;~-~::::::;
        ,,,;=!******!!!*****!;!*=*!;;-.   -:;;;!!!!!!!!!!;;:~:,,~::;:::::~~-,.,-~::;;!;;;;;;;;;;;::::::;;;~!
        ,,,!=:*!!!;;*=*!!!!***!!**!;:;,. .-:::;;;;;!;;;;;;::~!;-:::;::::::::~~~~::;;:!;;;;;;;;;;;:::::::;::!
        ,,,!=:!!!;!===*=====!=**!*;;:;~,,-~::;;;;!;!;;;;;;:::*;~:::::::~~~:~~~~~~~::::::::~~~~::::::::::::::
        .,,!=:!!!*==$$$$===***!*!!*;;:~~~~:::;;;;;;;;;::::~~:=:~~~~~~--,-~~~.        :        ,::::::~~~::.:
        ..,!=!!!!=$==$$$=$==*=!*!!!=;;;:~~~::;;;;;;;~........-,         ,~~.        .;..,,,,,-::::::~. .:;:!
        ..,!=!!!*$$$$$$$$$$=$==*!!*=!!;::~--:;;;;;;:,        ,-,..,.,,,. ,~~~~~~:::::=::~,~:::::::::::-::;::
        ..,!=!!!=$$$#$$$$=$====!!!*!*!!!~-,,-:;;;;;;:~~~~~~-~;:~~~~~~~~, -~:::::::::~*;;!!*!!;;!!!!;;!!***;;
        ...!*!;!$$$#$$#$$$$====!!!*==***;,,.-:;;;;;;;;::~~~~~:!;;;;;;;;:~~:;!*===*;;:!:~----;*===*!*;,,.,.  
        ..,!!;;!#$##$$$$=$$$==$;!;!!=*=*=!***;;;;;;!=$#$==*;:-*~-------,,,,,,,,,,,,--~!--,,*=*!===***!,....,
        ...!;!!*$$##==$**=====$:;;;*$====;;;;;;:::~~--,,,,,,..*,,,,,,,,.            .-;-,,;#=*~~:!*===!,,,,,
        ..,*=*!!$$#*:*;!!!;!***~:;;*=$=$=~~~~~~~----,.        ;      ,,  .......,,,,,-;---##*-....,:==$;,,,.
        ..,!;~~~=$$;-~~;!;!!;!;~~~:*;=$$*~~~~~~~----,....,,,,,;,,,,,,,,,,,,,,,,,,,,,--;-,-#=~,...   .*#=,   
        ..,!;~~~;==-,,,-:~*;;:~,-~:~~!==;~~~~~~~~-----,,,,,,,,;-,,,,,,,,,,,,....,,,---!~,!#;-,.....-, =#=,,,
        ..,*;~~:~;*--,,.,-~-,-,.,~$=!~!*~~~~~~~~------,,,,,,,,~:--,,,        .,,-,----*~,$@;-~:,.,,. .~##*.,
        ..,!;----;;-,,...,,,,,. .,--,,:*:!***;;~~---,      ...~:,,--,,,,,,,,--------- -, =@:~-,~..;~. .=@$,.
        ...!;--,~~:--,......,..  .,.. ~***!**=#!~~~~---,-,,---:;,----.    . .---------;:-#@:~:~,.....  !##~.
        ...!;----~~--,,... .,,.    .  ~$==$==*#$!~~~-,,.,,.,..;~,~,.,,----------------~!~$#:,,.,. .... :$#*.
        ...!;--,-----,,.. .,,,.      .:$$$===!*@*;~~~---------!:~----------------------!~$#;-,,~-,.....:$#$-
        ..,*:---,----,,....--~~-,.   .*$$==*;,,=$*~~~-~-------!~------,-,,,------,,-,,,;~$##~-,,~,  ...:=$$:
        ..~*~--------,,,...,:~~-,   ..$::~--, .:$*~~----------;:-,,,,,,,,,,,,,,,,,,-,,,;~=#@:--,---~...!*$#*
        ..:*-----~---,,,....,,,.    .-:-~~-.   ,$$!-----,,,,,,:;,,,,,,,,,,,,,,,,,,,-,,-!;=#@*---~-....-#$$$*
        ..!*-----~----,,,,,,,..   ...;-:-.-,.,-,-#*-------,-,,~!,,,,,,,,,,,--,,,,,,-,,-!;=@#@!--,,. .-~#$===
        ..**-----~~----,,-:~~~,-.....:,.~;-~-~,,-@;~-----------!-,,,,,,,,;$#$!,-~~~~~--;!=##@@=~,,,,-,,=$=**
        ..**~----~~~~----,--~:::~-..~-,,..,:-::--$~~~---------~*~--,,-~;=##$=$*~~:;*=*;!!=#@#@#:~---,.,*=##$
        ..!=~----~:::~~--,,--,,.,,,,~-,,~.- ,.. !=~;!**!;;;;:::!=#$*;;;;###$$$!-,,-----~*=#@#@@=~--,,,:!===*
        ..!=~:$#~~:;;::~----~~~-,,,:~---,-;,....-;;:~:::::~~--~=~---::::;;:$;$!,,,--,,--*$##@@@@~-,,,-:!$===
        !=$$##=:~~:;;;:~~-,,,,,,,,~=:--,~,.,,,,.,-~~~~~~~---~::*:--,~:::::,-,=*-,,,-,---*=$#@@@@;---,--!$$==
        $$$###;:~~~:;!;:~-,.,...,~*$;~-,---,,...,::~~~~~--~~:::**---~:::;:,,,,   ,,-----!$###@@@;~-----$$$==
        $$####::~~~~;;!;:-,,...,~!*$*:~,,,.....,;;;:~~~:::::::;!$---~:::::~~,.   .,-----;$#@@@@#!~--,,-#$$$$
        $$$###!:~--~~::;;;~----;;;*$$!:~,,,..,,:;;::~-.::::::;!!*:--::::~;!;,     .-----;=-##@###---,,*#$$$$
        $$$$##$~~---~::::::::-!;;;*=#=;:~-,,,,:::;.~:-.::::::::!*:~::::::~::.      ,----:#:$#####=--,-##$$$$
        $$$####~~----~::~~~~-~;;;*!$$#!:~~~-; ~:::,--,-:~~::!!~*;:~::::::-:~.       ,--~:$######@@#$=###$$$$
        $$$$###=-~---~::~~~--=!;;*!$=$*:~--;!*.:::-.~.,- ~:;!*:*;;:~.::::,~-.        --~:$$##@##@@######$$$$
        $$$$####!~~---~::~~-;$=!!*!*$$=---;;!*-:~;~ ,. . ,:;!;**!;;;~:;;!;**~---~~~~~~:::::;;~#@#@@@####$$$$
        $$$#$####;~~~~~~~--~#$==$$!*$==:-~=:!:::~;:. ..  -;!!:;!*;;;;!*!!!!!!!!!;;!!!!!!!!!!!;*#@@@@####$$$$
        $$$$$$####~~~:::~~~*$$$$#$*!=$!!:=!;*;;::::..-,..,;!*~:*!;;;:!-~-~!!!!!!!!!!!!!!!!!;;;;########$==$=
        =$$$$$#$##$~~:~~~~~$$=$=##=$=**!=;;;!*!!~~:.-~,  ,;!:~:;!;:;-;----!!!!!!!!!!!!!!!!;;;;;#$#####$$$==$
        ===$$$$#####:~~~~-*$$$$$##======*=;;!=;!~.~, .-- .!*;;:;;:!;,~!-,,~!!!!!!!!!!!!!!!!;;;;:$#####$$$$=#
        ===$$$$######*~-,,=$$$=$##$====*==!;*=;!:-:~,-~. ,!*!:.,~*;:--:!!!!!!!!!!!!!!!!!!;;;;;;;=####$=$$$*!
        ==$$$$$#####@##$=*=$$$=$#@$=====*=!!**!!!;~---:. -***...,,.....!!!!!!!!!!!!!!!!!!!!;;;;;;###$$$$$$;!
        =$=$$$###########$$$$$=$##$=$===$=**=**!;;~---!. ,~-!,,.,......:!!!!!!!!!!!!!!!!!!!;;;;;;$##@@@####@
        $$==$$$#######$$$$$$$$=$##$$$$=$==**=!*!*!---~;. ..,--..,...   .;!!!!!!!!!!!!!!!!!!!!;;;;!~,$#######
        $$$$$$##########$$$$$$$$##$$$$$$=$==*=**;:-,-,. .,,::~~~-=,-~~:-~;;;!!!!!!!!!*!!!!!!!;;;;:-~=$#$#$$#
        $=$$$$#########$$$$$$$$$##$$$$$$$$==*$==:~-,,,:;;;;-:~!!!!##=#!:.;;;!!!!******!!!!!!!!;;;;-,===$$=$#
    """


def save2df(load_dt='20220101'):
    PARQUET_PATH='~/t2/test_parquet'
    # 외부에서 입력 받는 DF가 없다면 날짜와 URL Param으로 데이터를 추출
    #if df is None:
    #    df = list2df(load_dt, url_params)
    df = req(load_dt)

    df['year'] = str(load_dt[0:4])
    df['month'] = str(load_dt[4:6])
    df['date'] = str(load_dt[6:9])

    print(str(load_dt[6:9]))

    partitions = [
    'year', 'month', 'date'
            ]
    exist_parquet(PARQUET_PATH, str(load_dt[0:4]), str(load_dt[4:6]), str(load_dt[6:9]))
    print(f"partitioning List : {partitions}")

    df.to_parquet(PARQUET_PATH, partition_cols=partitions)

    return df

def exist_parquet(parquet_path, year, month, date):
    import os
    up = os.path.expanduser(parquet_path)
    pf = os.path.join(up, f'year={year}', f'month={month}', f'date={date}')
    if os.path.exists(pf):
        import shutil
        shutil.rmtree(pf)

def req2list(load_dt='20220101', url_params={}) -> list:
    _, data = req(load_dt, url_params)
    l = data['boxOfficeResult']['dailyBoxOfficeList']
    return l

def list2df(load_dt='20120101', url_params={}):
    l = req2list(load_dt, url_params)
    df = pd.DataFrame(l)
    return df

def get_key():
    key = os.getenv('MOVIE_API_KEY')
    return key

def req(load_dt="20220101", url_params={}):
    url = gen_url(load_dt, url_params)
    r = requests.get(url)
    code = r.status_code
    data = r.json()
    df = pd.DataFrame(data['boxOfficeResult']['dailyBoxOfficeList'])
    print(data)
    return df

def gen_url(dt="20220101", url_params={}):
    base_url = "http://www.kobis.or.kr/kobisopenapi/webservice/rest/boxoffice/searchDailyBoxOfficeList.json"
    key = get_key()
    url = f"{base_url}?key={key}&targetDt={dt}"
    for k, v in url_params.items():
        url = url + f"&{k}={v}"
    return url